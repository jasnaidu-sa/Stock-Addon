<!DOCTYPE html>
<html>
<head>
    <title>Environment Variables Check</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .section { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Supabase Environment Check</h1>
    
    <div class="section">
        <h2>1. window.ENV Variables</h2>
        <div id="window-env-result"></div>
    </div>
    
    <div class="section">
        <h2>2. Script Tag Check</h2>
        <div id="script-tag-result"></div>
    </div>
    
    <div class="section">
        <h2>3. Direct API Test with Key</h2>
        <div id="direct-test-result"></div>
    </div>
    
    <script>
        // 1. Check window.ENV
        const windowEnvResult = document.getElementById('window-env-result');
        if (window.ENV) {
            const safeEnv = {
                VITE_SUPABASE_URL: window.ENV.VITE_SUPABASE_URL,
                VITE_SUPABASE_ANON_KEY: window.ENV.VITE_SUPABASE_ANON_KEY 
                    ? `${window.ENV.VITE_SUPABASE_ANON_KEY.substring(0, 10)}...${window.ENV.VITE_SUPABASE_ANON_KEY.substring(window.ENV.VITE_SUPABASE_ANON_KEY.length - 10)}`
                    : 'not available'
            };
            windowEnvResult.innerHTML = `<pre>${JSON.stringify(safeEnv, null, 2)}</pre>`;
            
            // Also show JWT expiration
            if (window.ENV.VITE_SUPABASE_ANON_KEY) {
                try {
                    const parts = window.ENV.VITE_SUPABASE_ANON_KEY.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        windowEnvResult.innerHTML += `<p>JWT Payload:</p><pre>${JSON.stringify(payload, null, 2)}</pre>`;
                        
                        if (payload.exp) {
                            const expDate = new Date(payload.exp * 1000);
                            windowEnvResult.innerHTML += `<p>Token expires: ${expDate.toLocaleString()}</p>`;
                        }
                    }
                } catch (e) {
                    windowEnvResult.innerHTML += `<p>Error parsing JWT: ${e.message}</p>`;
                }
            }
        } else {
            windowEnvResult.innerHTML = '<p>window.ENV is not defined!</p>';
        }
        
        // 2. Check if env-config.js script tag exists
        const scriptTagResult = document.getElementById('script-tag-result');
        const scripts = document.querySelectorAll('script');
        let envConfigFound = false;
        
        scripts.forEach(script => {
            if (script.src && script.src.includes('env-config.js')) {
                envConfigFound = true;
                scriptTagResult.innerHTML = `<p>✅ env-config.js script found: ${script.src}</p>`;
            }
        });
        
        if (!envConfigFound) {
            scriptTagResult.innerHTML = '<p>❌ env-config.js script not found in the page!</p>';
            
            // Try to load it dynamically to see if it exists
            const testScript = document.createElement('script');
            testScript.src = '/env-config.js';
            testScript.onload = () => {
                scriptTagResult.innerHTML += '<p>Successfully loaded env-config.js dynamically</p>';
                
                // Check if it defined window.ENV
                if (window.ENV) {
                    scriptTagResult.innerHTML += '<p>window.ENV was defined after loading the script</p>';
                }
            };
            testScript.onerror = () => {
                scriptTagResult.innerHTML += '<p>Failed to load env-config.js - file might not exist at expected path</p>';
            };
            document.head.appendChild(testScript);
        }
        
        // 3. Direct API test with current key
        async function testSupabaseApi() {
            const directTestResult = document.getElementById('direct-test-result');
            
            // Check if we have window.ENV available
            if (!window.ENV || !window.ENV.VITE_SUPABASE_ANON_KEY) {
                directTestResult.innerHTML = '<p>Cannot test API - no API key available</p>';
                return;
            }
            
            const url = window.ENV.VITE_SUPABASE_URL || 'https://cfjvskafvcljvxnawccs.supabase.co';
            const key = window.ENV.VITE_SUPABASE_ANON_KEY;
            
            directTestResult.innerHTML = `<p>Testing connection to ${url}</p>`;
            directTestResult.innerHTML += `<p>Using key: ${key.substring(0, 10)}...${key.substring(key.length - 10)}</p>`;
            
            try {
                // Test with the public endpoint
                const response = await fetch(`${url}/rest/v1/`, {
                    headers: {
                        'apikey': key,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    directTestResult.innerHTML += `<p style="color: green;">✅ API test successful (Status ${response.status})</p>`;
                } else {
                    directTestResult.innerHTML += `<p style="color: red;">❌ API test failed (Status ${response.status})</p>`;
                }
                
                directTestResult.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                // Now test the auth endpoint
                const authResponse = await fetch(`${url}/auth/v1/token?grant_type=password`, {
                    method: 'POST',
                    headers: {
                        'apikey': key,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'jnaidu@thebedshop.co.za',
                        password: 'admin123'
                    })
                });
                
                const authData = await authResponse.json();
                
                directTestResult.innerHTML += `<h3>Auth API Test (Status ${authResponse.status})</h3>`;
                if (authResponse.ok) {
                    directTestResult.innerHTML += `<p style="color: green;">✅ Auth test successful</p>`;
                } else {
                    directTestResult.innerHTML += `<p style="color: red;">❌ Auth test failed: ${authData.error || 'Unknown error'}</p>`;
                }
                
                directTestResult.innerHTML += `<pre>${JSON.stringify(authData, null, 2)}</pre>`;
                
            } catch (error) {
                directTestResult.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
        
        // Run the API test after a short delay to ensure other checks are complete
        setTimeout(testSupabaseApi, 500);
    </script>
</body>
</html> 