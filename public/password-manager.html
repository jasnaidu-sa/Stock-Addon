<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .user-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .user-info {
            margin-bottom: 10px;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
        }
        .status.admin {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .password-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Password Manager</h1>
        <p>Manage user passwords directly from the admin dashboard.</p>
        
        <button onclick="loadUsers()" id="loadBtn">Load All Users</button>
        <button onclick="generateRandomPassword()" class="success">Generate Random Password</button>
        
        <div id="message"></div>
    </div>

    <div class="container">
        <h2>üîç Find User</h2>
        <div class="form-group">
            <label for="searchUser">Search by name or email:</label>
            <input type="text" id="searchUser" placeholder="Type to search users..." oninput="filterUsers()">
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div>
                <h2>üë§ Reset User Password</h2>
                <div class="form-group">
                    <label for="userSelect">Select User:</label>
                    <select id="userSelect" onchange="selectUser()">
                        <option value="">Choose a user...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" placeholder="Enter new password (min 6 chars)">
                </div>
                
                <button onclick="resetUserPassword()" class="success">Reset Password</button>
                <button onclick="showPassword()" type="button">Show/Hide Password</button>
            </div>
            
            <div>
                <h2>‚úèÔ∏è Edit User</h2>
                <div id="editUserForm" style="display: none;">
                    <div class="form-group">
                        <label for="editUserName">Name:</label>
                        <input type="text" id="editUserName" placeholder="Enter user name">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserEmail">Email:</label>
                        <input type="email" id="editUserEmail" placeholder="Enter email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserRole">Role:</label>
                        <select id="editUserRole">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserStatus">Status:</label>
                        <select id="editUserStatus">
                            <option value="pending">Pending</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                    
                    <button onclick="saveUserEdits()" class="success">Save Changes</button>
                    <button onclick="cancelEdit()" type="button">Cancel</button>
                    
                    <input type="hidden" id="editUserId">
                </div>
                
                <div id="editUserPlaceholder">
                    <p>Select a user from the list below to edit their information.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div>
                <h2>üé≤ Password Generator</h2>
                <div class="form-group">
                    <label for="passwordLength">Password Length:</label>
                    <input type="number" id="passwordLength" value="12" min="6" max="50">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeUppercase" checked> Include Uppercase (A-Z)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeLowercase" checked> Include Lowercase (a-z)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeNumbers" checked> Include Numbers (0-9)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeSymbols" checked> Include Symbols (!@#$%)
                    </label>
                </div>
                
                <button onclick="generatePassword()" class="success">Generate Password</button>
                <button onclick="useGeneratedPassword()" type="button">Use This Password</button>
                
                <div id="generatedPassword" class="password-display" style="display: none;"></div>
            </div>
            
            <div>
                <h2>üóëÔ∏è User Management</h2>
                <div class="form-group">
                    <label>Bulk Actions:</label>
                    <button onclick="exportUsers()" type="button">Export Users</button>
                    <button onclick="showUserStats()" type="button">Show Statistics</button>
                </div>
                
                <div id="userStats" style="display: none; margin-top: 15px;">
                    <div class="password-display">
                        <div id="statsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üìã Users List</h2>
        <div id="usersList"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://cfjvskafvcljvxnawccs.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmanZza2FmdmNsanZ4bmF3Y2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA2MzczODQsImV4cCI6MjA1NjIxMzM4NH0.0kEvw4fWwp0Qw2fSXtmvcstZK3pYhS2yXiS0h68DEx0';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        const messageDiv = document.getElementById('message');
        const usersListDiv = document.getElementById('usersList');
        const userSelect = document.getElementById('userSelect');
        
        let allUsers = [];
        let selectedUser = null;
        
        function showMessage(text, type = 'info') {
            messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
        }
        
        async function loadUsers() {
            try {
                showMessage('Loading users...', 'info');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, name, email, status, role, created_at')
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                allUsers = users;
                populateUserSelect(users);
                displayUsers(users);
                
                showMessage(`Loaded ${users.length} users successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage(`Error: ${error.message}`, 'error');
            }
        }
        
        function populateUserSelect(users) {
            userSelect.innerHTML = '<option value="">Choose a user...</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.email})`;
                option.dataset.user = JSON.stringify(user);
                userSelect.appendChild(option);
            });
        }
        
        function selectUser() {
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            if (selectedOption.value) {
                selectedUser = JSON.parse(selectedOption.dataset.user);
                showMessage(`Selected user: ${selectedUser.name}`, 'info');
            } else {
                selectedUser = null;
            }
        }
        
        function filterUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            
            populateUserSelect(filteredUsers);
            displayUsers(filteredUsers);
        }
        
        function displayUsers(users) {
            usersListDiv.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-info">
                        <strong>${user.name}</strong> (${user.email})
                    </div>
                    <div class="user-info">
                        Role: <span class="status ${user.role}">${user.role}</span> | 
                        Status: <span class="status ${user.status}">${user.status}</span>
                    </div>
                    <div class="user-info">
                        Created: ${new Date(user.created_at).toLocaleDateString()}
                    </div>
                    <div>
                        <button onclick="quickSelectUser('${user.id}')" class="success">Select for Password Reset</button>
                        <button onclick="editUser('${user.id}')" type="button">Edit User</button>
                        <button onclick="deleteUser('${user.id}')" class="danger">Delete User</button>
                    </div>
                </div>
            `).join('');
        }
        
        function quickSelectUser(userId) {
            userSelect.value = userId;
            selectUser();
            document.getElementById('newPassword').focus();
        }
        
        async function resetUserPassword() {
            if (!selectedUser) {
                showMessage('Please select a user first', 'error');
                return;
            }
            
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) {
                showMessage('Please enter a new password', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showMessage('Password must be at least 6 characters long', 'error');
                return;
            }
            
            try {
                showMessage(`Resetting password for ${selectedUser.name}...`, 'info');
                
                // Try admin method first
                try {
                    const { error: adminError } = await supabase.auth.admin.updateUserById(
                        selectedUser.id,
                        { password: newPassword }
                    );
                    
                    if (adminError) throw adminError;
                    
                    showMessage(`‚úÖ Password updated successfully for ${selectedUser.name}!`, 'success');
                    
                } catch (adminError) {
                    console.log('Admin method failed, using fallback...');
                    
                    // Fallback method: recreate auth user
                    try {
                        await supabase.auth.admin.deleteUser(selectedUser.id);
                    } catch (deleteError) {
                        console.log('Could not delete existing user, continuing...');
                    }
                    
                    const { data: authData, error: authError } = await supabase.auth.signUp({
                        email: selectedUser.email,
                        password: newPassword,
                        options: {
                            data: {
                                name: selectedUser.name,
                                role: selectedUser.role
                            },
                            emailRedirectTo: undefined
                        }
                    });
                    
                    if (authError) {
                        if (authError.message.includes('User already registered')) {
                            showMessage(`‚ö†Ô∏è User already exists in auth system. Password may not have been updated. Consider using the email reset method.`, 'error');
                        } else {
                            throw authError;
                        }
                    } else {
                        // Update database if needed
                        if (authData.user && authData.user.id !== selectedUser.id) {
                            await supabase
                                .from('users')
                                .update({ 
                                    id: authData.user.id,
                                    status: 'active',
                                    email_confirmed_at: new Date().toISOString()
                                })
                                .eq('email', selectedUser.email);
                        }
                        
                        showMessage(`‚úÖ Password reset successfully for ${selectedUser.name}!`, 'success');
                    }
                }
                
                // Clear the password field
                document.getElementById('newPassword').value = '';
                
            } catch (error) {
                console.error('Error resetting password:', error);
                showMessage(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function generatePassword() {
            const length = parseInt(document.getElementById('passwordLength').value);
            const includeUppercase = document.getElementById('includeUppercase').checked;
            const includeLowercase = document.getElementById('includeLowercase').checked;
            const includeNumbers = document.getElementById('includeNumbers').checked;
            const includeSymbols = document.getElementById('includeSymbols').checked;
            
            let charset = '';
            if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
            if (includeNumbers) charset += '0123456789';
            if (includeSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
            
            if (!charset) {
                showMessage('Please select at least one character type', 'error');
                return;
            }
            
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            
            const passwordDiv = document.getElementById('generatedPassword');
            passwordDiv.textContent = password;
            passwordDiv.style.display = 'block';
            
            showMessage('Password generated successfully!', 'success');
        }
        
        function generateRandomPassword() {
            // Quick generate with default settings
            document.getElementById('passwordLength').value = 12;
            document.getElementById('includeUppercase').checked = true;
            document.getElementById('includeLowercase').checked = true;
            document.getElementById('includeNumbers').checked = true;
            document.getElementById('includeSymbols').checked = true;
            generatePassword();
        }
        
        function useGeneratedPassword() {
            const generatedPassword = document.getElementById('generatedPassword').textContent;
            if (generatedPassword) {
                document.getElementById('newPassword').value = generatedPassword;
                showMessage('Generated password copied to password field', 'success');
            } else {
                showMessage('Please generate a password first', 'error');
            }
        }
        
        function showPassword() {
            const passwordField = document.getElementById('newPassword');
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
            } else {
                passwordField.type = 'password';
            }
        }
        
        // User editing functions
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                showMessage('User not found', 'error');
                return;
            }
            
            // Populate the edit form
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserStatus').value = user.status;
            
            // Show the edit form and hide placeholder
            document.getElementById('editUserForm').style.display = 'block';
            document.getElementById('editUserPlaceholder').style.display = 'none';
            
            showMessage(`Editing user: ${user.name}`, 'info');
            
            // Scroll to edit form
            document.getElementById('editUserForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function saveUserEdits() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const role = document.getElementById('editUserRole').value;
            const status = document.getElementById('editUserStatus').value;
            
            // Validation
            if (!name || !email) {
                showMessage('Name and email are required', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showMessage('Please enter a valid email address', 'error');
                return;
            }
            
            try {
                showMessage('Saving user changes...', 'info');
                
                // Update user in database
                const { data, error } = await supabase
                    .from('users')
                    .update({
                        name: name,
                        email: email,
                        role: role,
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId)
                    .select();
                
                if (error) throw error;
                
                // Update local users array
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex] = { ...allUsers[userIndex], name, email, role, status };
                }
                
                // Refresh displays
                populateUserSelect(allUsers);
                displayUsers(allUsers);
                
                // Clear edit form
                cancelEdit();
                
                showMessage(`‚úÖ User updated successfully!`, 'success');
                
            } catch (error) {
                console.error('Error updating user:', error);
                showMessage(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function cancelEdit() {
            document.getElementById('editUserForm').style.display = 'none';
            document.getElementById('editUserPlaceholder').style.display = 'block';
            
            // Clear form
            document.getElementById('editUserId').value = '';
            document.getElementById('editUserName').value = '';
            document.getElementById('editUserEmail').value = '';
            document.getElementById('editUserRole').value = 'user';
            document.getElementById('editUserStatus').value = 'pending';
        }
        
        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                showMessage('User not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete user "${user.name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                showMessage(`Deleting user: ${user.name}...`, 'info');
                
                // Delete from auth system first
                try {
                    await supabase.auth.admin.deleteUser(userId);
                } catch (authError) {
                    console.log('Auth deletion failed, continuing with database deletion...');
                }
                
                // Delete from database
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                // Remove from local array
                allUsers = allUsers.filter(u => u.id !== userId);
                
                // Refresh displays
                populateUserSelect(allUsers);
                displayUsers(allUsers);
                
                // Clear edit form if this user was being edited
                if (document.getElementById('editUserId').value === userId) {
                    cancelEdit();
                }
                
                // Clear password reset selection if this user was selected
                if (selectedUser && selectedUser.id === userId) {
                    selectedUser = null;
                    userSelect.value = '';
                }
                
                showMessage(`‚úÖ User "${user.name}" deleted successfully!`, 'success');
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function exportUsers() {
            if (allUsers.length === 0) {
                showMessage('No users to export. Please load users first.', 'error');
                return;
            }
            
            const csvContent = [
                ['Name', 'Email', 'Role', 'Status', 'Created Date'].join(','),
                ...allUsers.map(user => [
                    `"${user.name}"`,
                    `"${user.email}"`,
                    user.role,
                    user.status,
                    new Date(user.created_at).toLocaleDateString()
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showMessage(`‚úÖ Exported ${allUsers.length} users to CSV file`, 'success');
        }
        
        function showUserStats() {
            if (allUsers.length === 0) {
                showMessage('No users loaded. Please load users first.', 'error');
                return;
            }
            
            const stats = {
                total: allUsers.length,
                byRole: {},
                byStatus: {},
                recentSignups: 0
            };
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            allUsers.forEach(user => {
                // Count by role
                stats.byRole[user.role] = (stats.byRole[user.role] || 0) + 1;
                
                // Count by status
                stats.byStatus[user.status] = (stats.byStatus[user.status] || 0) + 1;
                
                // Count recent signups
                if (new Date(user.created_at) > oneWeekAgo) {
                    stats.recentSignups++;
                }
            });
            
            const statsHtml = `
                <h4>üìä User Statistics</h4>
                <p><strong>Total Users:</strong> ${stats.total}</p>
                <p><strong>Recent Signups (7 days):</strong> ${stats.recentSignups}</p>
                
                <h5>By Role:</h5>
                ${Object.entries(stats.byRole).map(([role, count]) => 
                    `<p>‚Ä¢ ${role}: ${count} (${Math.round(count/stats.total*100)}%)</p>`
                ).join('')}
                
                <h5>By Status:</h5>
                ${Object.entries(stats.byStatus).map(([status, count]) => 
                    `<p>‚Ä¢ ${status}: ${count} (${Math.round(count/stats.total*100)}%)</p>`
                ).join('')}
            `;
            
            document.getElementById('statsContent').innerHTML = statsHtml;
            document.getElementById('userStats').style.display = 'block';
            
            showMessage('User statistics generated', 'success');
        }
        
        // Load users on page load
        window.onload = loadUsers;
    </script>
</body>
</html> 